# FastAnts å·¥ä½œæµå·¥ç¨‹æŒ‡å— (Workflow Engineering Guide)

æœ¬æ–‡æ¡£æä¾›äº†åœ¨ FastAnts ä¸­è®¾è®¡ã€ç¼–å†™å’Œä¼˜åŒ–å·¥ä½œæµçš„è¯¦ç»†æŒ‡å—ã€‚`workflow.yaml` æ–‡ä»¶æ˜¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„å¤§è„‘ï¼Œå®ƒå®šä¹‰äº†æ™ºèƒ½ä½“ã€å®ƒä»¬çš„è§’è‰²ä»¥åŠæŽ§åˆ¶å®ƒä»¬äº¤äº’çš„é€»è¾‘ã€‚

## ðŸ“‹ ç›®å½•

1.  [å·¥ä½œæµç»“æž„](#1-å·¥ä½œæµç»“æž„)
2.  [å…ƒæ•°æ® (Metadata)](#2-å…ƒæ•°æ®-metadata)
3.  [æ™ºèƒ½ä½“å®šä¹‰ (Agent Definition)](#3-æ™ºèƒ½ä½“å®šä¹‰-agent-definition)
4.  [çŠ¶æ€æœº (æ ¸å¿ƒ)](#4-çŠ¶æ€æœº-æ ¸å¿ƒ)
5.  [ç¼–å†™ Prompt](#5-ç¼–å†™-prompt)
6.  [æ¡ä»¶é€»è¾‘ (Condition Logic)](#6-æ¡ä»¶é€»è¾‘-condition-logic)
7.  [æœ€ä½³å®žè·µ](#7-æœ€ä½³å®žè·µ)

---

## 1. å·¥ä½œæµç»“æž„

ä¸€ä¸ªæœ‰æ•ˆçš„ `workflow.yaml` åŒ…å«å››ä¸ªä¸»è¦éƒ¨åˆ†ï¼š

```yaml
# 1. å…ƒæ•°æ®
name: "..."
description: "..."
initial_message: "..."
max_turns: 10

# 2. æ™ºèƒ½ä½“
agents:
  - ...

# 3. çŠ¶æ€ (å›¾èŠ‚ç‚¹)
states:
  - ...

# 4. é€€å‡ºæ¡ä»¶
exit_conditions:
  - ...
```

---

## 2. å…ƒæ•°æ® (Metadata)

å®šä¹‰å·¥ä½œæµèº«ä»½å’Œè¾¹ç•Œçš„å…¨å±€è®¾ç½®ã€‚

| å­—æ®µ | ç±»åž‹ | æè¿° | ç¤ºä¾‹ |
| :--- | :--- | :--- | :--- |
| `name` | `string` | å·¥ä½œæµçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å¿…é¡»ä¸Žæ–‡ä»¶å¤¹åç§°åŒ¹é…ã€‚ | `feature_dev` |
| `description` | `string` | äººç±»å¯è¯»çš„æè¿°ï¼Œè¯´æ˜Žå·¥ä½œæµçš„åŠŸèƒ½ã€‚ | `ååŒç‰¹æ€§å¼€å‘` |
| `initial_message` | `string` | ä¼ é€’ç»™ç¬¬ä¸€ä¸ªæ™ºèƒ½ä½“çš„å…¨å±€ç›®æ ‡æˆ–åˆå§‹æŒ‡ä»¤ã€‚ | `å®žçŽ°ç™»å½•é¡µé¢` |
| `max_turns` | `int` | é˜²æ­¢æ— é™å¾ªçŽ¯çš„å®‰å…¨é™åˆ¶ã€‚ | `20` |

---

## 3. æ™ºèƒ½ä½“å®šä¹‰ (Agent Definition)

å®šä¹‰æ­¤å·¥ä½œæµä¸­å¯ç”¨çš„â€œè§’è‰²é˜µå®¹â€ã€‚

```yaml
agents:
  - name: "architect"    # åœ¨ 'states' ä¸­ä½¿ç”¨çš„ ID
    type: "architect"    # ä½¿ç”¨ Aider çš„ ArchitectCoder (ä¾§é‡æŽ¨ç†)
  - name: "developer"    # åœ¨ 'states' ä¸­ä½¿ç”¨çš„ ID
    type: "coder"        # ä½¿ç”¨ Aider çš„æ ‡å‡† Coder (ä¾§é‡ç¼–ç é€Ÿåº¦)
```

*   **`type`**: ç›®å‰æ”¯æŒ `coder` (æ ‡å‡†) å’Œ `architect` (æŽ¨ç†åž‹)ã€‚

---

## 4. çŠ¶æ€æœº (æ ¸å¿ƒ)

`states` éƒ¨åˆ†å®šä¹‰äº† LangGraph çš„èŠ‚ç‚¹ã€‚æ¯ä¸ªçŠ¶æ€ä»£è¡¨ç‰¹å®šæ™ºèƒ½ä½“é‡‡å–è¡ŒåŠ¨çš„ä¸€ä¸ªå›žåˆã€‚

### çŠ¶æ€ç»“æž„

```yaml
states:
  - name: "design_phase"      # æ­¤çŠ¶æ€çš„å”¯ä¸€ ID
    agent: "architect"        # åœ¨æ­¤çŠ¶æ€ä¸‹è¡ŒåŠ¨çš„æ™ºèƒ½ä½“
    start: true               # æ ‡è®°ä¸ºå…¥å£ç‚¹ (åªèƒ½æœ‰ä¸€ä¸ªçŠ¶æ€ä¸º true)
    
    # æ­¤çŠ¶æ€çš„ç³»ç»Ÿæç¤ºè¯ (System Prompt)
    prompt: |
      ...
      
    # çŠ¶æ€æµè½¬ (Transitions)
    transitions:
      - to: "coding_phase"
        condition: "design_approved"
      - to: "design_phase"
        condition: "NOT design_approved"
```

---

## 5. ç¼–å†™ Prompt

Prompt æ˜¯ä½ å¯¹æ™ºèƒ½ä½“è¡Œä¸ºè¿›è¡Œç¼–ç¨‹çš„åœ°æ–¹ã€‚FastAnts ä½¿ç”¨ **Jinja2** æ¨¡æ¿æ¥å®žçŽ°åŠ¨æ€ Promptã€‚

### å¯ç”¨å˜é‡

*   `{{initial_message}}`: å…ƒæ•°æ®ä¸­å®šä¹‰çš„å…¨å±€ç›®æ ‡ã€‚
*   `{{last_agent_content}}`: ä¸Šä¸€ä¸ªæ™ºèƒ½ä½“çš„æ–‡æœ¬å›žå¤ã€‚
*   `{{last_agent_name}}`: ä¸Šä¸€ä¸ªè¡ŒåŠ¨çš„æ™ºèƒ½ä½“åç§°ã€‚
*   `{{COLLABORATION_GUIDE}}`: æ¥è‡ª `src/workflows/guide.py` çš„æ ‡å‡†æŒ‡å—ã€‚

### "æ–‡ä»¶ä¼˜å…ˆï¼ŒJSON åœ¨åŽ" è§„åˆ™

ä¸ºäº†ç¡®ä¿ç³»ç»Ÿå¯é è¿è¡Œï¼Œå¿…é¡»å¼ºåˆ¶æ‰§è¡Œä¸¥æ ¼çš„è¾“å‡ºæ ¼å¼ã€‚**è¯·åŠ¡å¿…åœ¨ Prompt ä¸­åŒ…å« `{{COLLABORATION_GUIDE}}`ã€‚**

æ™ºèƒ½ä½“çš„è¾“å‡º**å¿…é¡»**éµå¾ªæ­¤é¡ºåºï¼š
1.  **æ–‡ä»¶æ“ä½œ**ï¼šåˆ›å»ºæ–‡ä»¶ã€ç¼–å†™ä»£ç ã€Diffã€‚
2.  **JSON æŽ§åˆ¶å—**ï¼šä½äºŽæœ€åŽçš„ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å«å†³ç­–ä¿¡æ¯ã€‚

**Prompt ç¤ºä¾‹ï¼š**
```yaml
    prompt: |
      ä½ æ˜¯æž¶æž„å¸ˆã€‚
      ç›®æ ‡ï¼š{{initial_message}}
      
      å®¡æŸ¥ {{last_agent_name}} æäº¤çš„ä»£ç ã€‚
      
      {{COLLABORATION_GUIDE}}
      
      å›žå¤æ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼‰ï¼š
      {
        "content": "å®¡æŸ¥æ„è§...",
        "decisions": {
          "approved": true
        }
      }
```

---

## 6. æ¡ä»¶é€»è¾‘ (Condition Logic)

Transitions å†³å®šäº†å·¥ä½œæµçš„ä¸‹ä¸€æ­¥åŽ»å‘ã€‚FastAnts ä½¿ç”¨ç®€å•çš„è¡¨è¾¾å¼è¯„ä¼°å™¨ã€‚

### é€»è¾‘æº
æ¡ä»¶æ˜¯é’ˆå¯¹æ™ºèƒ½ä½“ JSON å“åº”è¿”å›žçš„ `decisions` å¯¹è±¡è¿›è¡Œè¯„ä¼°çš„ã€‚

**æ™ºèƒ½ä½“å“åº”ï¼š**
```json
{
  "decisions": {
    "is_finished": true,
    "has_errors": false
  }
}
```

**å·¥ä½œæµæµè½¬ï¼š**
```yaml
    transitions:
      - to: "end_state"
        condition: "is_finished AND NOT has_errors"
```

### æ”¯æŒçš„æ“ä½œç¬¦
*   `AND`, `OR`, `NOT`
*   `==`, `!=`, `>`, `<`, `>=`, `<=`
*   æ‹¬å· `()` ç”¨äºŽåˆ†ç»„

---

## 7. æœ€ä½³å®žè·µ

1.  **ä¿æŒ Prompt ç®€æ´**ï¼šå°†é€šç”¨æŒ‡ä»¤ç§»è‡³ `guide.py` å¹¶ä½¿ç”¨ `{{COLLABORATION_GUIDE}}`ã€‚è®© YAML ä¸­çš„ Prompt ä¸“æ³¨äºŽè¯¥çŠ¶æ€çš„ç‰¹å®šä¸šåŠ¡é€»è¾‘ã€‚
2.  **æ˜¾å¼å†³ç­–**ï¼šå¼ºåˆ¶æ™ºèƒ½ä½“åœ¨ JSON `decisions` å—ä¸­è¾“å‡ºå¸ƒå°”æ ‡å¿—ï¼ˆä¾‹å¦‚ `approved: true`ï¼‰ã€‚ä¸è¦ä¾èµ–è‡ªç„¶è¯­è¨€è§£æžã€‚
3.  **å¾ªçŽ¯å®‰å…¨**ï¼šå§‹ç»ˆè®¾ç½®å¤„ç†â€œå¤±è´¥â€æˆ–â€œé‡è¯•â€æƒ…å†µçš„æµè½¬ï¼ˆä¾‹å¦‚ `condition: "NOT approved"`ï¼‰ï¼Œå¦åˆ™å›¾å¯èƒ½ä¼šè¿‡æ—©ç»“æŸã€‚
4.  **Collab ç›®å½•**ï¼šæŒ‡ç¤ºæ™ºèƒ½ä½“å°†æ‰€æœ‰å…±äº«äº¤ä»˜ç‰©æ”¾åœ¨ `collab/` ç›®å½•ä¸‹ï¼Œä»¥ä¾¿å…¶ä»–æ™ºèƒ½ä½“å¯ä»¥è½»æ¾æ‰¾åˆ°å®ƒä»¬ã€‚
