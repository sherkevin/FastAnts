# MAS-AIDER Agent äº¤äº’æ¨¡å¼è¯¦è§£

## ğŸ¯ æ ¸å¿ƒæœºåˆ¶ï¼šAgent Keep-Alive

ä¿®å¤åï¼ŒMAS-AIDER å®ç°äº† **Agent æŒä¹…åŒ–ï¼ˆKeep-Aliveï¼‰** æœºåˆ¶ï¼ŒAgent åœ¨ä¼šè¯ä¸­ä¿æŒå­˜æ´»çŠ¶æ€ã€‚

## ğŸ”„ Agent äº¤äº’æµç¨‹

### åœºæ™¯ï¼šAgent A â†” Agent B å¤šæ¬¡äº¤äº’

```
å·¥ä½œæµå¼€å§‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MasAiderSession åˆ›å»º                    â”‚
â”‚  â€¢ EnvironmentService åˆå§‹åŒ–ï¼ˆä¸€æ¬¡ï¼‰                    â”‚
â”‚  â€¢ AgentService åˆå§‹åŒ–ï¼ˆä¸€æ¬¡ï¼‰                           â”‚
â”‚  â€¢ Agent ç¼“å­˜å­—å…¸ _active_agents: {}                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬1æ¬¡äº¤äº’ï¼šAgent A â†’ Agent B                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ State: client_request (Agent A)      â”‚              â”‚
â”‚  â”‚  â””â”€ get_agent_for_workflow("client") â”‚              â”‚
â”‚  â”‚     â””â”€ get_agent() æ£€æŸ¥ç¼“å­˜ â†’ âŒ ä¸å­˜åœ¨â”‚              â”‚
â”‚  â”‚        â””â”€ åˆ›å»ºæ–°å®ä¾‹ (ID: 140001)     â”‚              â”‚
â”‚  â”‚           â””â”€ å­˜å…¥ç¼“å­˜                 â”‚              â”‚
â”‚  â”‚              â””â”€ agent.run(prompt) æ‰§è¡Œâ”‚              â”‚
â”‚  â”‚                 â””â”€ è¿”å›å“åº”           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                    â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ State: supplier_clarify (Agent B)    â”‚              â”‚
â”‚  â”‚  â””â”€ get_agent_for_workflow("supplier")â”‚             â”‚
â”‚  â”‚     â””â”€ get_agent() æ£€æŸ¥ç¼“å­˜ â†’ âŒ ä¸å­˜åœ¨â”‚              â”‚
â”‚  â”‚        â””â”€ åˆ›å»ºæ–°å®ä¾‹ (ID: 140002)     â”‚              â”‚
â”‚  â”‚           â””â”€ å­˜å…¥ç¼“å­˜                 â”‚              â”‚
â”‚  â”‚              â””â”€ agent.run(prompt) æ‰§è¡Œâ”‚              â”‚
â”‚  â”‚                 â””â”€ è¿”å›å“åº”           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬2æ¬¡äº¤äº’ï¼šAgent A â†’ Agent B                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ State: client_request (Agent A)      â”‚              â”‚
â”‚  â”‚  â””â”€ get_agent_for_workflow("client") â”‚              â”‚
â”‚  â”‚     â””â”€ get_agent() æ£€æŸ¥ç¼“å­˜ â†’ âœ… å­˜åœ¨ï¼â”‚              â”‚
â”‚  â”‚        â””â”€ è¿”å›ç¼“å­˜å®ä¾‹ (ID: 140001)   â”‚ â† åŒä¸€ä¸ªå®ä¾‹ï¼â”‚
â”‚  â”‚           â””â”€ agent.run(prompt) æ‰§è¡Œ   â”‚              â”‚
â”‚  â”‚              â””â”€ ä¿ç•™å¯¹è¯å†å²          â”‚              â”‚
â”‚  â”‚                 â””â”€ è¿”å›å“åº”           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                    â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ State: supplier_create (Agent B)     â”‚              â”‚
â”‚  â”‚  â””â”€ get_agent_for_workflow("supplier")â”‚             â”‚
â”‚  â”‚     â””â”€ get_agent() æ£€æŸ¥ç¼“å­˜ â†’ âœ… å­˜åœ¨ï¼â”‚              â”‚
â”‚  â”‚        â””â”€ è¿”å›ç¼“å­˜å®ä¾‹ (ID: 140002)   â”‚ â† åŒä¸€ä¸ªå®ä¾‹ï¼â”‚
â”‚  â”‚           â””â”€ agent.run(prompt) æ‰§è¡Œ   â”‚              â”‚
â”‚  â”‚              â””â”€ ä¿ç•™å¯¹è¯å†å²          â”‚              â”‚
â”‚  â”‚                 â””â”€ è¿”å›å“åº”           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å·¥ä½œæµç»“æŸï¼ˆAgent ä»ç„¶å­˜æ´»åœ¨ _active_agents ä¸­ï¼‰
```

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. **Agent ä¸€ç›´ Alive**
```python
# Agent A çš„ç”Ÿå‘½å‘¨æœŸ
åˆ›å»ºæ—¶é—´: ç¬¬1æ¬¡è°ƒç”¨ get_agent()
å­˜æ´»æœŸé—´: æ•´ä¸ª MasAiderSession ç”Ÿå‘½å‘¨æœŸ
é”€æ¯æ—¶é—´: session.cleanup_workflow() æˆ–ä¼šè¯ç»“æŸ
```

### 2. **çŠ¶æ€ä¿æŒ**
æ¯ä¸ª Agent å®ä¾‹ä¿ç•™ï¼š
- âœ… **å¯¹è¯å†å²** - `.aider.chat.history.md`
- âœ… **æ–‡ä»¶æ„ŸçŸ¥** - è‡ªåŠ¨æ£€æµ‹ collab/ ç›®å½•çš„æ–‡ä»¶å˜åŒ–
- âœ… **ä¸Šä¸‹æ–‡è®°å¿†** - Aider å†…éƒ¨çš„å¯¹è¯ä¸Šä¸‹æ–‡
- âœ… **å·¥ä½œç›®å½•** - Agent çš„ä¸ªäººå·¥ä½œç©ºé—´

### 3. **ä¸æ˜¯å®æ—¶ç­‰å¾…**
Agent ä¸ä¼šåƒæœåŠ¡å™¨ä¸€æ ·"ç›‘å¬"è¯·æ±‚ï¼Œè€Œæ˜¯ï¼š
- åœ¨å†…å­˜ä¸­ä¿æŒå®ä¾‹
- çŠ¶æ€æœºè°ƒç”¨æ—¶"å”¤é†’"æ‰§è¡Œ
- æ‰§è¡Œå®Œæˆå"ä¼‘çœ "ç­‰å¾…ä¸‹æ¬¡è°ƒç”¨

## ğŸ“Š ç¼“å­˜é”®è®¾è®¡

```python
cache_key = f"{workflow_name}:{agent_name}:{workspace_path}"
# ç¤ºä¾‹: "hulatang:client:/tmp/workspaces/hulatang"
```

**éš”ç¦»æ€§ä¿è¯**ï¼š
- ä¸åŒå·¥ä½œæµçš„åŒå Agent æ˜¯ç‹¬ç«‹å®ä¾‹
- åŒä¸€å·¥ä½œæµçš„åŒå Agent å¤ç”¨åŒä¸€å®ä¾‹
- å·¥ä½œåŒºè·¯å¾„å˜åŒ–ä¼šåˆ›å»ºæ–°å®ä¾‹

## ğŸ”„ å¤šæ¬¡äº¤äº’ç¤ºä¾‹

### hulatang å·¥ä½œæµçš„å®é™…äº¤äº’

```yaml
# å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ï¼š
client_request (client)          # åˆ›å»º client Agent
    â†“
supplier_clarify (supplier)      # åˆ›å»º supplier Agent
    â†“
client_request (client)          # å¤ç”¨ client Agent âœ…
    â†“
supplier_create (supplier)       # å¤ç”¨ supplier Agent âœ…
    â†“
client_review (client)           # å¤ç”¨ client Agent âœ…
    â†“
supplier_revise (supplier)       # å¤ç”¨ supplier Agent âœ…
```

**Agent å®ä¾‹æ•°é‡**: åªåˆ›å»ºäº† 2 ä¸ªï¼ˆclient å’Œ supplierï¼‰
**å¤ç”¨æ¬¡æ•°**: client å¤ç”¨ 2 æ¬¡ï¼Œsupplier å¤ç”¨ 2 æ¬¡
**å†…å­˜æ•ˆç‡**: é«˜ï¼ˆé¿å…é‡å¤åˆå§‹åŒ–ï¼‰
**ä¸Šä¸‹æ–‡è¿ç»­æ€§**: å®Œç¾ï¼ˆä¿ç•™æ‰€æœ‰å¯¹è¯å†å²ï¼‰

## ğŸ’¬ Agent é—´ä¿¡æ¯ä¼ é€’

### ä¸¤å±‚ä¼ é€’æœºåˆ¶

#### 1. **æ–‡ä»¶ç³»ç»Ÿä¼ é€’ï¼ˆæ˜¾å¼ï¼‰**
```
Agent A â†’ å†™å…¥ collab/requirements.md
            â†“
Agent B â†’ è¯»å– collab/requirements.md
```

#### 2. **å“åº”ä¼ é€’ï¼ˆæœªæ¥å®ç°ï¼‰**
```
Agent A â†’ è¿”å›å“åº” {"content": "æˆ‘å·²å®Œæˆéœ€æ±‚åˆ†æ", "decisions": {...}}
            â†“ (å­˜å…¥ global_state)
Agent B â†’ æ”¶åˆ° prompt: "å‰ä¸€ä¸ªAgentçš„ç»“æœï¼šæˆ‘å·²å®Œæˆéœ€æ±‚åˆ†æ"
```

## ğŸ†š ä¸è€å¸ˆç‰ˆæœ¬çš„å¯¹æ¯”

| ç‰¹æ€§ | è€å¸ˆçš„LangGraphç‰ˆæœ¬ | å½“å‰YAMLç‰ˆæœ¬ |
|------|-------------------|-------------|
| **AgentæŒä¹…åŒ–** | âœ… åœ¨è¿›ç¨‹ä¸­å­˜æ´» | âœ… åœ¨ä¼šè¯ä¸­å­˜æ´» |
| **çŠ¶æ€ç®¡ç†** | LangGraph State | æ–‡ä»¶ç³»ç»Ÿ + global_state |
| **äº¤äº’æ¨¡å¼** | æ¶ˆæ¯ä¼ é€’ | æ–‡ä»¶ä¼ é€’ + å“åº”ä¼ é€’ |
| **é…ç½®æ–¹å¼** | Pythonä»£ç  | YAMLé…ç½® |
| **ç¼“å­˜é”®** | æ— ï¼ˆéšå¼ï¼‰ | workflow:agent:workspace |
| **æ¸…ç†æ§åˆ¶** | è¿›ç¨‹ç»“æŸ | ä¼šè¯æ§åˆ¶ + æ‰‹åŠ¨æ¸…ç† |

## ğŸš€ ä½¿ç”¨å»ºè®®

### å•æ¬¡è¿è¡Œåœºæ™¯
```python
from mas_aider.main import main
main("hulatang")  # ç®€å•ç›´æ¥
```

### å¤šæ¬¡è¿è¡Œåœºæ™¯ï¼ˆæ¨èï¼‰
```python
from mas_aider.main import MasAiderSession

session = MasAiderSession()

# è¿ç»­è¿è¡Œï¼ŒAgentä¿æŒå­˜æ´»
session.run_workflow("hulatang")
session.run_workflow("collaboration")
session.run_workflow("hulatang")  # å¤ç”¨ä¹‹å‰çš„Agent

# æŸ¥çœ‹ç»Ÿè®¡
info = session.get_session_info()
print(f"ç¼“å­˜Agentæ•°: {info['cached_agents']['total_cached_agents']}")
```

### ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆæœ€ä¼˜é›…ï¼‰
```python
with MasAiderSession() as session:
    session.run_workflow("hulatang")
    session.run_workflow("collaboration")
# è‡ªåŠ¨æ¸…ç†
```

## ğŸ‰ æ€»ç»“

**å½“å‰ Agent äº¤äº’æ¨¡å¼**ï¼š
- âœ… **Agent ä¸€ç›´ alive**ï¼šåœ¨ä¼šè¯ä¸­ä¿æŒå­˜æ´»
- âœ… **å®ä¾‹å¤ç”¨**ï¼šåŒä¸€ä¸ª Agent å¤šæ¬¡è°ƒç”¨ä½¿ç”¨åŒä¸€å®ä¾‹
- âœ… **çŠ¶æ€ä¿æŒ**ï¼šå¯¹è¯å†å²ã€æ–‡ä»¶æ„ŸçŸ¥ã€å·¥ä½œç›®å½•éƒ½æŒä¹…åŒ–
- âœ… **é«˜æ•ˆæ‰§è¡Œ**ï¼šé¿å…é‡å¤åˆå§‹åŒ–ï¼Œæ€§èƒ½æå‡æ˜¾è‘—

**ä¸ä½ è€å¸ˆæè¿°çš„ä¸€è‡´æ€§**ï¼šå®Œå…¨ä¸€è‡´ï¼Agent ç¡®å®æ˜¯"ä¸€ç›´æ´»ç€"ï¼Œè€Œä¸æ˜¯æ¯æ¬¡é‡å¯ã€‚ ğŸ¯
